<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start Screen</title>
    <link rel="stylesheet" href="main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* ★追加: JSで表示/非表示を切り替えるためのクラス */
        .hidden {
            display: none !important;
        }

        /* ★修正: QRリーダーセクションのスタイリング */
        #qr-reader-section {
            /* display: none; ← 削除 (hiddenクラスで制御) */
            width: 100%;
            
            /* ★追加: 中身を中央揃えにするためのFlex設定 */
            display: flex;
            flex-direction: column;
            align-items: center; /* 水平方向の中央揃え */
        }

        /* 以下のスタイルは変更なし */
        #preview {
            width: 100vw;
            max-width: 500px; 
            aspect-ratio: 1;
            margin: 0 auto;
            border: 2px solid #ccc;
        }
        #qr-result-display {
            font-size: 2vh;
            text-align: center;
            min-height: 2.5vh;
            margin-top: 10px;
        }
        #cancel-qr-btn {
            margin-top: 15px;
            background-color: #555;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }
        .modal-content h2 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 1.2rem;
            text-align: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            width: 100%;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

    </style>
</head>

<body>
    <main>
        <div id="start-screen">
            <img src="images/code_logo.png" alt="失われし文字" class="game-logo">
            
            <div class="difficulty-selector">
                <a href="select2.html" class="btn easy-btn">easy</a>
                
                <a href="select.html" class="btn normal-btn">normal</a>
                <a href="#" id="qr-start-btn" class="btn easy-btn">card scan</a>
                <a href="#" id="manual-id-btn" class="btn normal-btn">type id</a>
            </div>

            <div id="qr-reader-section" class="hidden">
                <video id="preview" playsinline></video>
                <p id="qr-result-display">id: <span id="result">スキャン中...</span></p>
                <button id="cancel-qr-btn" class="btn">キャンセル</button>
            </div>
        </div>
    </main>
    
    <div id="id-input-modal" class="modal hidden">
        <div class="modal-content">
            <h2>ID入力</h2>
            <div class="input-group">
                <input type="text" id="manual-id-input" placeholder="IDを入力（半角英数字）">
                <div class="button-group">
                    <button id="modal-submit" class="btn normal-btn">決定</button>
                    <button id="modal-cancel" class="btn">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ★修正: ゲーム開始時に「両方」のモードのデータをクリア
        function clearAllGameData() {
            try {
                // --- localStorage のクリア (既存) ---
                localStorage.removeItem('slate_quest_answers_v1_normal');
                localStorage.removeItem('slate_quest_state_v1_normal');
                localStorage.removeItem('startTime_normal');
                localStorage.removeItem('finalClearTime_normal');
                localStorage.removeItem('finalMistakeCount_normal');
    
                localStorage.removeItem('slate_quest_answers_v1_easy');
                localStorage.removeItem('slate_quest_state_v1_easy');
                localStorage.removeItem('startTime_easy');
                localStorage.removeItem('finalClearTime_easy');
                localStorage.removeItem('finalMistakeCount_easy');
                
                localStorage.removeItem('slate_quest_answers_v1');
                localStorage.removeItem('slate_quest_state_v1');
                localStorage.removeItem('startTime');

                // ★★★ ここから追加 ★★★
                // --- sessionStorage のクリア (Normalモードの問題パターン) ---
                // (slate.js で定義されているキー)
                sessionStorage.removeItem('gimmick1_combination');
                sessionStorage.removeItem('gimmick2_combination');
                sessionStorage.removeItem('gimmick3_combination');
                sessionStorage.removeItem('gimmick4_combination');
                // ★★★ ここまで追加 ★★★
    
            } catch (e) {
                console.warn("ストレージのクリアに失敗:", e);
            }
        }
    
        // ★追加: ボタンにイベントリスナーを設定
        const easyBtn = document.querySelector('.easy-btn');
        const normalBtn = document.querySelector('.normal-btn');
    
        if (easyBtn) {
            easyBtn.addEventListener('click', (e) => {
                e.preventDefault(); 
                clearAllGameData();
                sessionStorage.setItem('gameMode', 'easy');
                window.location.href = easyBtn.href;
            });
        }
    
        if (normalBtn) {
            normalBtn.addEventListener('click', (e) => {
                e.preventDefault();
                clearAllGameData();
                sessionStorage.setItem('gameMode', 'normal');
                window.location.href = normalBtn.href;
            });
        }
    </script>

    <script type="module">
        import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";

        // DOM要素を取得
        const qrStartBtn = document.getElementById('qr-start-btn');
        const difficultySelector = document.querySelector('.difficulty-selector');
        const qrReaderSection = document.getElementById('qr-reader-section');
        const preview = document.getElementById('preview');
        const resultEl = document.getElementById('result');
        const cancelQrBtn = document.getElementById('cancel-qr-btn');
        
        // ★追加: ロゴ要素を取得
        const gameLogo = document.querySelector('.game-logo');

        const manualBtn = document.getElementById('manual-id-btn');
        const modal = document.getElementById('id-input-modal');
        const modalInput = document.getElementById('manual-id-input');
        const modalSubmit = document.getElementById('modal-submit');
        const modalCancel = document.getElementById('modal-cancel');

        const codeReader = new BrowserMultiFormatReader();
        let stream = null; 

        if (manualBtn) {
            manualBtn.addEventListener('click', (e) => {
                e.preventDefault();
                modal.classList.remove('hidden');
                modalInput.focus();
            });
        }

        // モーダルの送信処理
        modalSubmit.addEventListener('click', () => {
            const input = modalInput.value;
            if (input && input.trim() !== '') {
                const uid = input.trim();
                try {
                    localStorage.setItem('uid', uid);
                    localStorage.setItem('correctAnswers', '0');
                    console.log('Manual ID saved:', uid);
                    
                    const resultEl = document.getElementById('result');
                    if (resultEl) resultEl.textContent = `IDセット: ${uid}`;
                    
                    modal.classList.add('hidden');
                    modalInput.value = '';
                } catch (err) {
                    console.warn('localStorage への保存に失敗:', err);
                    alert('IDの保存に失敗しました。ブラウザの設定を確認してください。');
                }
            }
        });

        // モーダルのキャンセル処理
        modalCancel.addEventListener('click', () => {
            modal.classList.add('hidden');
            modalInput.value = '';
        });

        // モーダル外クリックで閉じる
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                modalInput.value = '';
            }
        });

        // エンターキーで送信
        modalInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                modalSubmit.click();
            }
        });

        // QRリーダーを開始する関数
        async function startQRCodeReader() {
            try {
                // ★修正: UI切り替え (inlineスタイルではなくクラスを操作)
                difficultySelector.classList.add('hidden');
                gameLogo.classList.add('hidden'); // ロゴも非表示
                qrReaderSection.classList.remove('hidden'); // QRリーダーを表示

                resultEl.textContent = "スキャン中..."; 

                const constraints = {
                    video: {
                        facingMode: "environment" 
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                preview.srcObject = stream;
                preview.play(); 

                codeReader.decodeFromStream(stream, preview, (result, err) => {
                    if (result) {
                        const text = result.getText();

                        // QRテキストから id を抽出するヘルパー
                        function extractIdFromQrText(txt) {
                            if (!txt) return '';
                            const t = txt.trim();
                            // まず URL として解釈して検索パラメータから取得
                            try {
                                let maybeUrl = t;
                                if (!/^https?:\/\//i.test(maybeUrl) && maybeUrl.includes('/')) {
                                    maybeUrl = 'https://' + maybeUrl;
                                }
                                const u = new URL(maybeUrl);
                                const id = u.searchParams.get('id') || u.searchParams.get('uid') || u.searchParams.get('userId');
                                if (id) return id;
                            } catch (e) {
                                // URL として解析できない場合はフォールバックへ
                            }
                            // クエリ文字列・単純パターンから抽出
                            const m = t.match(/[?&]id=([^&]+)/i) || t.match(/\bid=([^&\/\s]+)/i);
                            if (m) return decodeURIComponent(m[1]);
                            // 最終手段：全文を返す
                            return t;
                        }

                        const uid = extractIdFromQrText(text);

                        if (uid) {
                            resultEl.textContent = `ID取得: ${uid}`;
                            console.log('検出:', uid);
                            
                            try {
                                localStorage.setItem('uid', uid);
                                localStorage.setItem('correctAnswers', '0');
                            } catch (e) {
                                console.warn("localStorage への保存に失敗:", e);
                                resultEl.textContent = "IDの保存に失敗しました。";
                                stopQRCodeReader(); 
                                return;
                            }

                            stopQRCodeReader(true); 
                            window.location.href = 'index.html'; 
                        }
                    }
                    if (err && err.name !== 'NotFoundException') {
                        console.error(err);
                        resultEl.textContent = "読み取りエラーが発生しました。";
                    }
                });

            } catch (err) {
                console.error("カメラの起動に失敗しました。", err);
                resultEl.textContent = "カメラの起動に失敗しました。";
                
                // ★修正: エラー時もクラスでUIを元に戻す
                difficultySelector.classList.remove('hidden');
                gameLogo.classList.remove('hidden'); // ロゴを表示
                qrReaderSection.classList.add('hidden'); // QRリーダーを非表示
            }
        }

        // QRリーダーを停止・キャンセルする関数
        function stopQRCodeReader(keepUi = false) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (!keepUi) {
                // ★修正: UIをクラスで元に戻す
                difficultySelector.classList.remove('hidden');
                gameLogo.classList.remove('hidden'); // ロゴを表示
                qrReaderSection.classList.add('hidden'); // QRリーダーを非表示
                resultEl.textContent = "スキャン中...";
            }
        }

        // qrStartBtn のクリックイベント (変更なし)
        qrStartBtn.addEventListener('click', (e) => {
            e.preventDefault(); 
            startQRCodeReader();
        });

        // キャンセルボタンのクリックイベント (変更なし)
        cancelQrBtn.addEventListener('click', (e) => {
            e.preventDefault();
            stopQRCodeReader();
        });

    </script>
</body>
</html>